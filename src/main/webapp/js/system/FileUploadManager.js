FileUploadManager=Ext.extend(Ext.Window,{imagePanel:null,imageStore:null,dataView:null,tpl:null,panel:null,store:null,treePanel:null,gridPanel:null,tabPanel:null,constructor:function(a){Ext.applyIf(this,a);this.initUIComponent();FileUploadManager.superclass.constructor.call(this,{id:"fileUploadManager",layout:"fit",title:"附件分类管理",iconCls:"menu-file",width:680,height:396,maximizable:true,border:false,modal:true,plain:true,items:this.tabPanel,buttonAlign:"center",buttons:[{text:"确定",iconCls:"btn-ok",scope:this,handler:this.upLoad},{text:"取消",iconCls:"btn-cancel",scope:this,handler:this.close}]});},initUIComponent:function(){this.treePanel=new Ext.tree.TreePanel({region:"west",id:"fileUploadManagerFilesTreePanel",title:"附件分类",collapsible:true,autoScroll:true,split:true,width:150,tbar:new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",handler:function(){Ext.getCmp("fileUploadManagerFilesTreePanel").root.reload();}},{xtype:"button",text:"展开",iconCls:"btn-expand",handler:function(){Ext.getCmp("fileUploadManagerFilesTreePanel").expandAll();}},{xtype:"button",text:"收起",iconCls:"btn-collapse",handler:function(){Ext.getCmp("fileUploadManagerFilesTreePanel").collapseAll();}}]}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/system/loadTreeFileAttach.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":function(g){if(g!=null){var h="";switch(g.getDepth()){case 2:h=g.parentNode.text+"/"+g.text;break;case 3:h=g.parentNode.parentNode.text+"/"+g.parentNode.text+"/"+g.text;break;default:h=g.text;break;}h=g.isLeaf()?h+"%":h;var f=Ext.getCmp("fileUploadManager").gridPanel.getStore();f.url=__ctxPath+"/system/listFileAttach.do";f.baseParams={Q_fileType_S_LK:h};f.reload({params:{start:0,limit:10}});}}}});this.imageTreePanel=new Ext.tree.TreePanel({region:"west",id:"fileUploadManagerimageTypeTreePanel",title:"图片分类",collapsible:true,autoScroll:true,split:true,width:150,tbar:new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",handler:function(){Ext.getCmp("fileUploadManagerimageTypeTreePanel").root.reload();}},{xtype:"button",text:"展开",iconCls:"btn-expand",handler:function(){Ext.getCmp("fileUploadManagerimageTypeTreePanel").expandAll();}},{xtype:"button",text:"收起",iconCls:"btn-collapse",handler:function(){Ext.getCmp("fileUploadManagerimageTypeTreePanel").collapseAll();}}]}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/system/loadTreeFileAttach.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":function(g){if(g!=null){var h="";switch(g.getDepth()){case 2:h=g.parentNode.text+"/"+g.text;break;case 3:h=g.parentNode.parentNode.text+"/"+g.parentNode.text+"/"+g.text;break;default:h=g.text;break;}h=g.isLeaf()?h+"%":h;var f=Ext.getCmp("fileUploadManager").dataView.getStore();f.url=__ctxPath+"/system/listFileAttach.do";f.baseParams={Q_fileType_S_LK:h};f.reload({params:{start:0,limit:6}});}}}});var c=new Ext.Toolbar({id:"fileUploadManagerTopbar",height:30,menuAlign:"center",defaultType:"button",items:[{text:"上传",iconCls:"btn-upload",handler:this.upLoadFile}]});this.store=new Ext.data.JsonStore({url:__ctxPath+"/system/listFileAttach.do?type=file",root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"fileId",type:"int"},{name:"filename",mapping:"fileName"},"ext","note","fileType","filePath","createtime","totalBytes"],remoteSort:false});this.store.load({params:{start:0,limit:10}});var b=new Ext.ux.grid.RowActions({header:"管理",width:80,actions:[{iconCls:"btn-showDetail",qtip:"查看",style:"margin:0 3px 0 3px"},{iconCls:"btn-downLoad",qtip:"下载",style:"margin:0 3px 0 3px"}]});var e=new Ext.grid.CheckboxSelectionModel();var a=new Ext.grid.ColumnModel({columns:[e,new Ext.grid.RowNumberer(),{header:"fileId",dataIndex:"fileId",hidden:true},{header:"附件名称",dataIndex:"filename"},{header:"上传时间",dataIndex:"createtime",format:"y-m-d"},{header:"大小",dataIndex:"note"},b],defaults:{sortable:true,menuDisabled:true}});this.gridPanel=new Ext.grid.GridPanel({id:"fileUploadManagerGridPanel",layout:"form",region:"center",tbar:c,loadMask:true,height:300,store:this.store,plugins:b,cm:a,sm:e,viewConfig:{forceFit:true,autoFill:true},bbar:new Ext.PagingToolbar({pageSize:10,store:this.store,displayInfo:true,displayMsg:"当前显示从{0}至{1}，共有{2}条记录",emptyMsg:"对不起，当前没有数据！"})});this.gridPanel.addListener("rowdblclick",function(f,h,g){f.getSelectionModel().each(function(i){FileAttachDetail.show(i.data.fileId);});});b.on("action",this.onRowAction,this);this.panel=new Ext.Panel({height:300,id:"fileUploadManagerPanel",iconCls:"menu-find-doc",layout:"border",region:"center",items:[this.treePanel,this.gridPanel]});this.imageStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/system/listFileAttach.do?type=image"}),reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"fileId",type:"int"},{name:"filename",mapping:"fileName"},"filePath"]}),remoteSort:true});this.imageStore.setDefaultSort("createtime","DESC");this.imageStore.load({params:{start:0,limit:8}});this.tpl=new Ext.XTemplate('<tpl for=".">','<div style="width:105px; height : 105px;" class="thumb-wrap" id="{fileId}">','<img align="middle" src="'+__ctxPath+'/attachFiles/{filePath}" style="width:90px;height:90px;margin-left:7px;" title="{fileName}"/>','<center><span style="margin-top:3px;">{filename}</span><center>',"</div>","</tpl>"),this.dataView=new Ext.DataView({store:this.imageStore,tpl:this.tpl,height:240,multiSelect:true,overClass:"x-view-over",itemSelector:"div.thumb-wrap",bodyStyle:"padding:4px",emptyText:"目前尚无记录",listeners:{"dblclick":{fn:this.imageDbClick.createCallback(this),scope:this}}});this.imagePanel=new Ext.Panel({id:"fileUploadManageImagePanel",height:300,width:"100%",layout:"border",region:"center",items:[this.imageTreePanel,{height:310,region:"center",layout:"fit",tbar:[{text:"上传",iconCls:"btn-upload",handler:this.upLoadImage}],autoHeight:true,items:this.dataView,bbar:new Ext.PagingToolbar({pageSize:8,store:this.imageStore,displayInfo:true,displayMsg:"当前显示从{0}至{1}， 共{2}条记录",emptyMsg:"当前没有记录"})}]});var d=this.permitted_extensions;if(d=="bmp"||d=="jpg"||d=="tiff"||d=="gif"){this.tabPanel=new Ext.TabPanel({id:"fileUploadMangerTabPanel",activeTab:0,items:[{title:"上传图片",items:[this.imagePanel]}]});}else{this.tabPanel=new Ext.TabPanel({id:"fileUploadMangerTabPanel",activeTab:0,items:[{title:"上传附件",items:[this.panel]}]});}},onRowAction:function(c,a,d,e,b){switch(d){case"btn-showDetail":this.showdetail(a.data.fileId);break;case"btn-downLoad":this.downLoad(a.data.fileId);break;}},showdetail:function(a){FileAttachDetail.show(a);},downLoad:function(a){window.open(__ctxPath+"/file-downLoad?fileId="+a);},upLoadFile:function(){var a=App.createUploadDialog2({file_cat:this.file_cat,url:this.url,callback:function(c){if(c!=null){var b=Ext.getCmp("fileUploadManagerGridPanel");b.getStore().baseParams={Q_fileType_S_LK:this.file_cat};b.getStore().reload({params:{start:0,limit:10}});}}});a.show("file");},upLoadImage:function(){var a=App.createUploadDialog2({file_cat:this.file_cat,callback:function(c){if(c!=null){var b=Ext.getCmp("fileUploadManager").dataView.getStore();b.url=__ctxPath+"/system/listFileAttach.do?type=image";b.baseParams={Q_fileType_S_LK:this.file_cat};b.reload({params:{start:0,limit:8}});}}});a.show("image");},upLoad:function(){var f=Ext.getCmp("fileUploadMangerTabPanel");var d=Ext.getCmp("fileUploadManagerGridPanel");var b=d.getSelectionModel().getSelections();var e=this.permitted_extensions;if(e=="bmp"||e=="jpg"||e=="tiff"||e=="gif"){b=Ext.getCmp("fileUploadManager").dataView.getSelectedRecords();}var a=new Array();for(var c=0;c<b.length;c++){a.push(b[c].data);}if(this.callback!=null){this.callback.call(this,a);}Ext.getCmp("fileUploadManager").close();},imageDbClick:function(b){var a=b.dataView.getSelectedNodes();if(a!=""&&a!=null&&a!="undefined"){FileUploadImageDetailForm.show(a[0].id);}}});